---
 - name: Register variables through shell scripts
   hosts: CV_LCL
   #hosts: CRON_DEPLOY
   #hosts: CV
   gather_facts: true
   become: true
   vars:
   tasks:
   - name: Register a common port for Tomcat
     shell: ss -lnt | grep "8000" | sed -n 's/^.*8000/8000/gp' | awk '{print $1}'
     register: TOMCAT_PORT
   - set_fact:
       TM_PORT: "{{ TOMCAT_PORT.stdout }}"

   - name: Register Tomcat service
     shell: systemctl list-units | grep Tomcat | grep active | awk -F ' ' '{print $1}'
     register: TOMCAT_SERVICE
     when: (TM_PORT == "8000")

   - name: Register Tomcat installation directory
     shell: systemctl cat "{{ TOMCAT_SERVICE.stdout }}" | grep "ExecStart=" | awk -F '=' '{print $2}' | awk -F '/bin/startup.sh' '{print $1}'
     register: TOMCAT_DIR
     when: (TM_PORT == "8000")

   - name: Register Tomcat log directory
     shell: cat "{{ TOMCAT_DIR.stdout }}"/conf/server.xml | grep "directory=" | tr -d '"' | awk -F '=' '{print $NF}'
     register: TOMCAT_LOG_DIR
     when: (TM_PORT == "8000")

   - name: Check to see if UIKIT has already been installed on the server
     stat:
       path: "{{ TOMCAT_DIR.stdout }}/webapps/ui_kit.war"
     register: UIKIT_WAR
     when: (TM_PORT == "8000")

   - name: Register TOMCAT TMP directory
     shell: grep "^tmp.dir=" "{{ TOMCAT_DIR.stdout }}"/webapps/cv/WEB-INF/classes/parameters.cfg | awk -F '=' '{print $NF}'
     register: TOMCAT_TMP_DIR
     when: (TM_PORT == "8000") and UIKIT_WAR.stat.exists == False 

   - name: Print variables for Tomcat
     debug:
       msg:
        - TOMCAT Port:- "{{ TOMCAT_PORT.stdout }}"
        - TOMCAT SERVICE:- "{{ TOMCAT_SERVICE.stdout }}"
        - TOMCAT Install Directory:- "{{ TOMCAT_DIR.stdout }}"
        - TOMCAT LOG Directory:- "{{ TOMCAT_LOG_DIR.stdout }}"
     when: (TM_PORT == "8000")

   - name: Print variables for Tomcat TMP directory
     debug:
       msg:
        - TOMCAT TMP Directory:- "{{ TOMCAT_TMP_DIR.stdout }}"
     when: (TM_PORT == "8000") and UIKIT_WAR.stat.exists == False 
